generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ACCOUNTANT
  STAFF
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum AttendanceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AuditAction {
  CREATED
  UPDATED
  APPROVED
  REJECTED
  DELETED
}

enum SalaryType {
  MONTHLY
  HOURLY
}

enum NotificationChannel {
  EMAIL
  INAPP
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum OtpPurpose {
  LOGIN
  VERIFY_PHONE
  REGISTER
  RESET_PASSWORD
   
}

enum ReportType {
  ATTENDANCE
  SALARY
  USER
  COMPANY
}
model Company {
  id          String        @id @default(uuid()) @db.Uuid
  name        String
  description String?
  status      AccountStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  users         User[]
  attendances   Attendance[]
  salaries      Salary[]
  notifications Notification[]
  reports       Report[]
  invitations   CompanyInvitation[]

  @@map("companies")
}

model CompanyInvitation {
  id          String   @id @default(uuid()) @db.Uuid
  companyId   String   @db.Uuid
  email       String
  phone       String
  role        Role     @default(STAFF)
  token       String   @unique
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])

  @@map("company_invitations")
}

model User {
  id                   String        @id @default(uuid()) @db.Uuid
  firstName            String?
  lastName             String?
  email                String        @unique
  phone                String        @unique
  password             String
  role                 Role
  status               AccountStatus @default(ACTIVE)
  companyId            String?       @db.Uuid
  onboardingCompleted  Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  company           Company?          @relation(fields: [companyId], references: [id])
  attendances       Attendance[]
  approvedAttendance Attendance[]     @relation("ApprovedBy")
  salaries          Salary[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  auditLogs         AuditLog[]

  @@map("users")
}
model Attendance {
  id             String           @id @default(uuid()) @db.Uuid
  userId         String           @db.Uuid
  companyId      String           @db.Uuid
  attendanceDate DateTime         @db.Date
  punchIn        DateTime
  punchOut       DateTime?
  imageUrl       String
  status         AttendanceStatus @default(PENDING)
  approvedBy     String?          @db.Uuid
  approvedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  user            User    @relation(fields: [userId], references: [id])
  company         Company @relation(fields: [companyId], references: [id])
  approvedByUser  User?   @relation("ApprovedBy", fields: [approvedBy], references: [id])
  audits          AuditLog[]

  @@unique([userId, attendanceDate])
  @@index([companyId, attendanceDate])
}
model Salary {
  id           String      @id @default(uuid()) @db.Uuid
  userId       String      @db.Uuid
  companyId    String      @db.Uuid
  month        Int
  year         Int

  totalDays    Float
  approvedDays Float
  grossAmount  Float
  netAmount    Float
  type         SalaryType
  status       String      @default("PENDING")
  paidAt       DateTime? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@unique([userId, month, year])
  @@index([companyId, month, year])
}
model Otp {
  id        String     @id @default(uuid()) @db.Uuid
  phone     String
  otp       String
  purpose   OtpPurpose
  expiresAt DateTime
  isUsed    Boolean    @default(false)
  createdAt DateTime   @default(now())
  deliveryStatus    String?  @default("PENDING") // PENDING, SENT, DELIVERED, FAILED
  deliveryAttempts  Int      @default(0)
  deliveryChannels  Json?    // Array of channels used: ["SMS", "Email"]
  deliveryResults   Json?    // Detailed delivery results with retry info
  
  @@map("Otp")
}
model Notification {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  companyId String              @db.Uuid
  title     String
  message   String
  channel   NotificationChannel
  status    NotificationStatus  @default(PENDING)
  meta      Json?
  createdAt DateTime            @default(now())

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@index([userId, status])
}
model PushSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
model Report {
  id        String     @id @default(uuid()) @db.Uuid
  companyId String     @db.Uuid
  type      ReportType
  title     String
  filters   Json
  fileUrl   String?
  createdAt DateTime   @default(now())

  company Company @relation(fields: [companyId], references: [id])
}
model AuditLog {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String      @db.Uuid
  action    AuditAction
  entity    String
  entityId  String
  meta      Json?
  createdAt DateTime    @default(now())
  attendance   Attendance? @relation(fields: [attendanceId], references: [id])
  attendanceId String?     @db.Uuid

  user User @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
}


// System Settings for Platform Management
model SystemSetting {
   id          String   @id @default(cuid())
   category    String   // e.g., "platform", "security"
   key         String   // Setting key within category
   value       String   // JSON string of the setting value
   description String?  // Human-readable description
   isPublic    Boolean  @default(false) // Whether setting is visible to non-admin users
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   @@unique([category, key])
   @@map("system_settings")
}
model NotificationLog {
  id            String   @id @default(cuid())
  type          String   // notification type (invitation, order, etc.)
  channel       String   // email, whatsapp, sms, push, in_app
  recipient     String   // email address, phone number, or user ID
  status        String   // sent, failed, pending
  errorMessage  String?  // error details if failed
  provider      String?  // MSG91, Resend, FCM, etc.
  messageId     String?  // external provider message ID
  cost          Float?   // cost of sending (if applicable)
  metadata      Json?    // additional data (template used, etc.)
  sentAt        DateTime?
  createdAt     DateTime @default(now())

  @@index([type, status])
  @@index([channel, createdAt])
  @@index([recipient])
  @@map("notification_logs")
}
