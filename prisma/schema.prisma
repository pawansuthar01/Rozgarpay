generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  relationMode = "prisma"
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ACCOUNTANT
  STAFF
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum AttendanceStatus {
  PENDING
  APPROVED
  REJECTED
  ABSENT
  LEAVE
}

enum AuditAction {
  CREATED
  UPDATED
  APPROVED
  REJECTED
  DELETED
}

enum CorrectionType {
  MISSED_PUNCH_IN
  MISSED_PUNCH_OUT
  ATTENDANCE_MISS
  LEAVE_REQUEST
  SUPPORT_REQUEST
  SALARY_REQUEST
}

enum SalaryType {
  MONTHLY
  HOURLY
  DAILY
}

enum NotificationChannel {
  EMAIL
  IN_APP
  WHATSAPP
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum OtpPurpose {
  LOGIN
  VERIFY_PHONE
  REGISTER
  RESET_PASSWORD
   
}

enum ReportType {
  ATTENDANCE
  SALARY
  USER
  COMPANY
}

enum SalaryLedgerType {
   PAYMENT
   RECOVERY
   EARNING
   DEDUCTION
}

enum CashbookTransactionType {
   SALARY_PAYMENT
   ADVANCE
   RECOVERY
   VENDOR_PAYMENT
   CLIENT_PAYMENT
   EXPENSE
   ADJUSTMENT
}

enum CashbookDirection {
   CREDIT
   DEBIT
}

enum PaymentMode {
   CASH
   BANK
   UPI
   CHEQUE
}
model Company {
   id          String        @id @default(uuid()) @db.Uuid
   name        String
   description String?
   logo        String?       // URL to company logo image
   status      AccountStatus @default(ACTIVE)
   // Attendance & Payroll Settings
   shiftStartTime      String?       @default("09:00") // HH:MM format
   shiftEndTime        String?       @default("18:00") // HH:MM format
   gracePeriodMinutes  Int?          @default(30) // Late arrival grace period
   minWorkingHours     Float?        @default(4.0) // Minimum hours to count as working day
   maxDailyHours       Float?        @default(16.0) // Maximum hours per day
   autoPunchOutBufferMinutes Int?    @default(30) // Buffer after shift end for auto punch-out
   locationLat         Float?        // Company location latitude
   locationLng         Float?        // Company location longitude
   locationRadius      Float?        @default(100.0) // GPS verification radius in meters
   overtimeThresholdHours Float?     @default(2.0) // Hours after which overtime needs approval
   nightPunchInWindowHours Float?    @default(2.0) // Max hours after shift start for night shift punch-in
   // Salary Settings
   defaultSalaryType       SalaryType?   @default(MONTHLY)
   overtimeMultiplier      Float?        @default(1.5) // Overtime rate multiplier
   enableLatePenalty       Boolean?      @default(false) // Whether to apply late penalties
   latePenaltyPerMinute    Float?        @default(0) // Penalty per late minute
   enableAbsentPenalty     Boolean?      @default(false) // Whether to apply absent penalties
   halfDayThresholdHours   Float?        @default(4.0) // Hours below which it's half day
   absentPenaltyPerDay     Float?        @default(0) // Penalty for absent day
   pfPercentage            Float?        @default(12.0) // PF percentage
   esiPercentage           Float?        @default(0.75) // ESI percentage
   createdAt               DateTime      @default(now())
   updatedAt               DateTime      @updatedAt

   users         User[]
   attendances   Attendance[]
   salaries      Salary[]
   salaryLedgers SalaryLedger[]
   cashbookEntries CashbookEntry[]
   notifications Notification[]
   reports       Report[]
   invitations   CompanyInvitation[]
   correctionRequests CorrectionRequest[]
   shiftConfigurations ShiftConfiguration[]

   @@map("companies")
 }

model CompanyInvitation {
   id          String   @id @default(uuid()) @db.Uuid
   companyId   String   @db.Uuid
   email       String
   phone       String
   role        Role     @default(STAFF)
   token       String   @unique
   expiresAt   DateTime
   isUsed      Boolean  @default(false)
   createdAt   DateTime @default(now())

   company Company @relation(fields: [companyId], references: [id])

   @@index([companyId])
   @@index([email])
   @@map("company_invitations")
 }

model ShiftConfiguration {
   id          String   @id @default(uuid()) @db.Uuid
   companyId   String   @db.Uuid
   name        String   // e.g., "Day Shift", "Night Shift"
   startTime   String   // HH:MM format
   endTime     String   // HH:MM format
   isActive    Boolean  @default(true)
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   company Company @relation(fields: [companyId], references: [id])

   @@unique([companyId, name])
   @@map("shift_configurations")
 }

model User {
  id                   String        @id @default(uuid()) @db.Uuid
  firstName            String?
  lastName             String?
  email                String?        @unique
  phone                String        @unique
  password             String
  profileImg           String?       // URL to profile image
  role                 Role
  status               AccountStatus @default(ACTIVE)
  companyId            String?       @db.Uuid
  onboardingCompleted  Boolean       @default(false)
  // Salary Configuration
  baseSalary           Float?        // Monthly base salary
  hourlyRate           Float?        // Hourly rate for hourly workers
  dailyRate            Float?        // Daily rate for daily workers
  salaryType           SalaryType?   @default(MONTHLY) // Default salary type
  workingDays          Int?          @default(26) // Working days per month (26 or 22)
  overtimeRate         Float?        // Overtime rate per hour (optional)
  pfEsiApplicable      Boolean?      @default(false) // PF/ESI applicable
  joiningDate          DateTime?     // Employee joining date
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
 salarySetupDone Boolean @default(false)

  company           Company?          @relation(fields: [companyId], references: [id])
  attendances       Attendance[]
  approvedAttendance Attendance[]     @relation("ApprovedBy")
  salaries          Salary[]
  approvedSalaries  Salary[]          @relation("SalaryApprovedBy")
  rejectedSalaries  Salary[]          @relation("SalaryRejectedBy")
  salaryLedgers     SalaryLedger[]    @relation("LedgerUser")
  createdLedgers    SalaryLedger[]    @relation("LedgerCreatedBy")
  cashbookEntries   CashbookEntry[]
  createdCashbookEntries CashbookEntry[] @relation("CashbookCreator")
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  auditLogs         AuditLog[]
  correctionRequests CorrectionRequest[]
  reviewedCorrections CorrectionRequest[] @relation("CorrectionReviewedBy")

  @@index([companyId, role])
  @@index([companyId, status])
  @@index([email])
  @@index([phone])
  @@map("users")
}
model Attendance {
   id             String           @id @default(uuid()) @db.Uuid
   userId         String           @db.Uuid
   companyId      String           @db.Uuid
   attendanceDate DateTime
   LateMinute Int? @default(0)
      

   punchIn        DateTime?
   punchOut       DateTime?
   punchInLocation Json?           // {lat: number, lng: number}
   punchOutLocation Json?          // {lat: number, lng: number}
   punchInImageUrl String?
   punchOutImageUrl String?
   autoPunchOut   Boolean          @default(false)
   autoPunchedOut Boolean          @default(false) // Whether punched out by auto system
   autoPunchOutAt DateTime?        // When auto punch-out occurred
   workingHours   Float?           // Calculated working hours
   overtimeHours  Float?           @default(0) // Overtime hours worked
   isLate         Boolean          @default(false) // Late punch-in flag
   shiftDurationHours Float?        // Manual shift duration in hours (for night shifts)
   status         AttendanceStatus @default(PENDING)
   requiresApproval Boolean        @default(false) // Whether this attendance needs manager approval
   approvalReason  String?         // Reason why approval is required
   approvedBy     String?          @db.Uuid
   approvedAt     DateTime?
   rejectionReason String?         // Reason for rejection
   createdAt      DateTime         @default(now())
   updatedAt      DateTime         @updatedAt
   salaryBlocked Boolean @default(false)
   user            User    @relation(fields: [userId], references: [id])
   company         Company @relation(fields: [companyId], references: [id])
   approvedByUser  User?   @relation("ApprovedBy", fields: [approvedBy], references: [id])
   audits          AuditLog[]
   correctionRequests CorrectionRequest[]

   @@unique([userId, companyId, attendanceDate])
   @@index([companyId, attendanceDate])
   @@index([companyId, status])
   @@index([userId, status, attendanceDate])
   @@index([companyId, attendanceDate, status])
   @@index([userId, companyId])
 }

model CorrectionRequest {
  id             String           @id @default(uuid()) @db.Uuid
  userId         String           @db.Uuid
  companyId      String           @db.Uuid
  attendanceId   String?          @db.Uuid
  attendanceDate  DateTime
  endDate        DateTime?        // For leave requests - end date of leave period
  type           CorrectionType
  requestedTime  DateTime?        // For missed punch out/in, the requested punch time
  requestedAmount Float?          // For salary requests - amount requested
  reason         String           // Staff's reason for the request
  evidence       String?          // URL to evidence file
  status         AttendanceStatus @default(PENDING)
  reviewedBy     String?          @db.Uuid
  reviewedAt     DateTime?
  reviewReason   String?          // Admin's reason for approval/rejection
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user            User       @relation(fields: [userId], references: [id])
  company         Company    @relation(fields: [companyId], references: [id])
  attendance      Attendance? @relation(fields: [attendanceId], references: [id])
  reviewedByUser  User?      @relation("CorrectionReviewedBy", fields: [reviewedBy], references: [id])
  audits          AuditLog[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@index([userId, attendanceDate])
  @@index([userId, status])
 }

model Salary {
  id                String      @id @default(uuid()) @db.Uuid
  userId            String      @db.Uuid
  companyId         String      @db.Uuid
  month             Int
  year              Int

  // Summary
  totalWorkingDays   Float       @default(0)
  totalWorkingHours  Float       @default(0)
  overtimeHours      Float       @default(0)
  lateMinutes        Int         @default(0)
  halfDays           Int         @default(0)
  absentDays         Int         @default(0)

  // Amounts
  baseAmount         Float       @default(0)
  overtimeAmount     Float       @default(0)
  penaltyAmount      Float       @default(0)
  deductions         Float       @default(0) // PF, ESI, etc.
  grossAmount        Float
  netAmount          Float

  type               SalaryType
  status             String      @default("PENDING") // PENDING, APPROVED, PAID, REJECTED
  paidAt             DateTime?

  // Approval
  approvedBy         String?     @db.Uuid
  approvedAt         DateTime?
  rejectedBy         String?     @db.Uuid
  rejectedAt         DateTime?
  rejectionReason    String?

  // Locking and versioning
  lockedAt           DateTime?
  recalculatedAt     DateTime?
  version            Int         @default(1)

  // PDF Storage
  pdfUrl             String?

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  user               User        @relation(fields: [userId], references: [id])
  company            Company     @relation(fields: [companyId], references: [id])
  approvedByUser     User?           @relation("SalaryApprovedBy", fields: [approvedBy], references: [id])
  rejectedByUser     User?           @relation("SalaryRejectedBy", fields: [rejectedBy], references: [id])
  breakdowns         SalaryBreakdown[]
  ledger             SalaryLedger[]
  audits             AuditLog[]

  @@unique([userId, month, year])
  @@index([companyId, month, year])
  @@index([companyId, status])
  @@index([userId, status])
  @@index([companyId, year, month])
}

model SalaryBreakdown {
  id          String   @id @default(uuid()) @db.Uuid
  salaryId    String   @db.Uuid
  type        String   // e.g., "BASE_SALARY", "OVERTIME", "LATE_PENALTY", "PF_DEDUCTION", "ESI_DEDUCTION"
  description String
  amount      Float
  hours       Float?   // Applicable for overtime, working hours
  quantity    Float?   // Number of days, minutes, etc.
  createdAt   DateTime @default(now())

  salary Salary @relation(fields: [salaryId], references: [id])

  @@index([salaryId])
  @@map("salary_breakdowns")
}

model SalaryLedger {
  id          String          @id @default(uuid()) @db.Uuid
  salaryId    String          @db.Uuid
  userId      String          @db.Uuid
  companyId   String          @db.Uuid
  type        SalaryLedgerType
  amount      Float
  reason      String
  reference   String?         // Payment reference, transaction ID, etc.
  createdBy   String          @db.Uuid
  createdAt   DateTime        @default(now())

  salary      Salary          @relation(fields: [salaryId], references: [id])
  user        User            @relation("LedgerUser", fields: [userId], references: [id])
  company     Company         @relation(fields: [companyId], references: [id])
  creator     User            @relation("LedgerCreatedBy", fields: [createdBy], references: [id])

  @@index([salaryId])
  @@index([userId])
  @@index([companyId])
  @@index([type])
  @@index([createdAt])
  @@map("salary_ledgers")
}

model CashbookEntry {
  id              String                 @id @default(uuid()) @db.Uuid
  companyId       String                 @db.Uuid
  userId          String?                @db.Uuid  // Optional: staff/vendor/client
  transactionType CashbookTransactionType
  direction       CashbookDirection
  amount          Float
  paymentMode     PaymentMode?
  reference       String?                // salaryId, attendanceId, invoiceId, etc.
  description     String
  notes           String?
  transactionDate DateTime               @default(now())
  createdBy       String                 @db.Uuid
  reversalOf      String?                @db.Uuid  // Reference to reversed transaction
  isReversed      Boolean                @default(false)
  createdAt       DateTime               @default(now())

  company         Company                @relation(fields: [companyId], references: [id])
  user            User?                  @relation(fields: [userId], references: [id])
  creator         User                   @relation("CashbookCreator", fields: [createdBy], references: [id])
  reversedEntry   CashbookEntry?         @relation("CashbookReversal", fields: [reversalOf], references: [id], onDelete: Restrict, onUpdate: Restrict)
  reversals       CashbookEntry[]        @relation("CashbookReversal")

  @@index([companyId, transactionDate])
  @@index([companyId, direction])
  @@index([companyId, userId])
  @@index([reference])
  @@index([createdAt])
  @@index([companyId, transactionDate, direction])
  @@map("cashbook_entries")
}

model Otp {
  id        String     @id @default(uuid()) @db.Uuid
  phone     String?
  email     String?
  otp       String
  purpose   OtpPurpose
  expiresAt DateTime
  isUsed    Boolean    @default(false)
  createdAt DateTime   @default(now())
  deliveryStatus    String?  @default("PENDING") // PENDING, SENT, DELIVERED, FAILED
  deliveryAttempts  Int      @default(0)
  deliveryChannels  Json?    // Array of channels used: ["SMS", "Email"]
  deliveryResults   Json?    // Detailed delivery results with retry info
  
  @@index([phone, purpose])
  @@index([email, purpose])
  @@map("Otp")
}
model Notification {
  id        String              @id @default(uuid()) @db.Uuid
  userId    String              @db.Uuid
  companyId String              @db.Uuid
  title     String
  message   String
  channel   NotificationChannel
  status    NotificationStatus  @default(PENDING)
  meta      Json?
  createdAt DateTime            @default(now())

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@index([userId, status])
  @@index([companyId, createdAt])
  @@index([userId, createdAt])
}
model PushSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
model Report {
  id        String     @id @default(uuid()) @db.Uuid
  companyId String     @db.Uuid
  type      ReportType
  title     String
  filters   Json
  fileUrl   String?
  createdAt DateTime   @default(now())

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId, type])
  @@index([createdAt])
}
model AuditLog {
   id        String      @id @default(uuid()) @db.Uuid
   userId    String      @db.Uuid
   action    AuditAction
   entity    String
   entityId  String
   meta      Json?
   createdAt DateTime    @default(now())
   correctionRequestId String?            @db.Uuid
   correctionRequest   CorrectionRequest? @relation(fields: [correctionRequestId], references: [id])
   attendanceId        String?            @db.Uuid
   attendance          Attendance?        @relation(fields: [attendanceId], references: [id])
   salaryId            String?            @db.Uuid
   salary              Salary?            @relation(fields: [salaryId], references: [id])

   user User @relation(fields: [userId], references: [id])

   @@index([entity, entityId])
   @@index([userId])
   @@index([createdAt])
 }


 // System Settings for Platform Management
model SystemSetting {
   id          String   @id @default(cuid())
   category    String   // e.g., "platform", "security"
   key         String   // Setting key within category
   value       String   // JSON string of the setting value
   description String?  // Human-readable description
   isPublic    Boolean  @default(false) // Whether setting is visible to non-admin users
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   @@unique([category, key])
   @@map("system_settings")
}
model NotificationLog {
  id            String   @id @default(cuid())
  type          String   // notification type (invitation, order, etc.)
  channel       String   // email, whatsapp, sms, push, in_app
  recipient     String   // email address, phone number, or user ID
  status        String   // sent, failed, pending
  errorMessage  String?  // error details if failed
  provider      String?  // MSG91, Resend, FCM, etc.
  messageId     String?  // external provider message ID
  cost          Float?   // cost of sending (if applicable)
  metadata      Json?    // additional data (template used, etc.)
  sentAt        DateTime?
  createdAt     DateTime @default(now())

  @@index([type, status])
  @@index([channel, createdAt])
  @@index([recipient])
  @@map("notification_logs")
}
